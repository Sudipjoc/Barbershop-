<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Booking Page</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    body {
      background: #f0f0f0;
    }
    .booking-section {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      margin-top: 50px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .default_btn {
      background-color: #000;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
    }
  </style>
  <!-- Add CryptoJS for eSewa signature -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/hmac-sha256.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/enc-base64.min.js"></script>
   -->
  <!-- Existing stylesheets remain unchanged -->
  <link rel="stylesheet" href="css/elegant-font-icons.css">
  <!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <link rel="stylesheet" href="css/elegant-font-icons.css">
  <link rel="stylesheet" href="css/elegant-line-icons.css">
  <link rel="stylesheet" href="css/themify-icons.css">
  <link rel="stylesheet" href="css/barber-icons.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/animate.min.css">
  <link rel="stylesheet" href="css/venobox/venobox.css">
  <link rel="stylesheet" href="css/nice-select.css">
  <link rel="stylesheet" href="css/owl.carousel.css">
  <link rel="stylesheet" href="css/slicknav.min.css">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/responsive.css">

<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://khalti.com/static/khalti-checkout.js"></script>
  <!-- ... other existing stylesheets ... -->
</head>
<body>
  <!-- Header section remains unchanged -->
   <header id="header" class="header-section">
        <div class="container">
            <nav class="navbar ">
                <a href="#" class="navbar-brand" style="color: white">BarberShop</a>
                <div class="d-flex menu-wrap align-items-center">
                    <div id="mainmenu" class="mainmenu">
                        <ul class="nav">
                            <li><a data-scroll class="nav-link active" href="index2.html">Home<span
                                        class="sr-only">(current)</span></a>
                                <ul>

                                </ul>
                            </li>          
                            <li><a href="services2.html">Services</a>
                            </li>
                            <li><a href="#">Pages</a>
                                <ul>
                                    <li><a href="appointment.html">Appointment</a></li>
                                    <li><a href="team2.html">Our Team</a></li>
                                </ul>
                            </li>
                        </ul>
                    </div>
                    <div class="header-btn">
                        <a href="Userdashboard.html" class="menu-btn">Dashboard</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

  <br>
  <br>
  <br>
  <!-- ... existing header code ... -->

<div class="container">
  <div class="booking-section">
    <h2 class="text-center mb-4">Book a Service</h2>
     <form id="booking_form">
      <div class="row">
        <div class="col-md-6 mb-3">
          <input type="text" id="book_name" class="form-control" placeholder="Your Name" required>
        </div>
        <div class="col-md-6 mb-3">
          <input type="email" id="book_email" class="form-control" placeholder="Email" required>
        </div>
        <div class="col-md-6 mb-3">
          <input type="text" id="book_phone" class="form-control" placeholder="Phone Number" required>
        </div>
        <div class="col-md-6 mb-3">
          <input type="text" id="book_area" class="form-control" placeholder="Location" readonly>
        </div>
        <div class="col-md-6 mb-3">
          <select id="book_service" class="form-control" required>
            <option value="">Select Service</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <select id="book_barber" class="form-control" required>
            <option value="">Select Barber</option>
          </select>
        </div>
        <div class="col-md-6 mb-3">
          <input type="text" id="book_time" class="form-control" placeholder="Pick Date & Time" required>
        </div>
        <div class="col-md-6 mb-3">
          <select id="book_payment" class="form-control" required>
            <option value="Cash">Cash</option>
            <option value="Online">Online</option>
          </select>
        </div>
      </div>
      <div class="text-center">
        <button type="submit" class="default_btn">Confirm Booking</button>
        <div id="book_msg" class="alert mt-3" style="display:none;"></div>
      </div>
    </form>
  </div>
</div>

<section class="widget_section padding">
  <div class="container">
      <div class="row">
          <div class="col-lg-3 col-md-6 sm-padding">
              <div class="footer_widget">
                  <img class="mb-15" src="img/logo.png" alt="Brand">
                  <p>Our website is the created for men who appreciate premium quality, time and flawless look.
                  </p>
                  <ul class="widget_social">
                      <li><a href="#"><i class="social_facebook"></i></a></li>
                      <li><a href="#"><i class="social_twitter"></i></a></li>
                      <li><a href="#"><i class="social_googleplus"></i></a></li>
                      <li><a href="#"><i class="social_instagram"></i></a></li>
                      <li><a href="#"><i class="social_linkedin"></i></a></li>
                  </ul>
              </div>
          </div>
          <div class="col-lg-3 col-md-6 sm-padding">
              <div class="footer_widget">
                  <h3>Headquaters</h3>
                  <p>New Baneshor</p>
                  <p><a href="https://html.dynamiclayers.net/cdn-cgi/l/email-protection" class="__cf_email__"
                          data-cfemail="024a676e6e6d42667b6c636f6b616e637b6770712c6c6776">[email&#160;protected]</a>
                      <br>+1234567890</p>
              </div>
          </div>
          <!-- <div class="col-lg-3 col-md-6 sm-padding">
              <div class="footer_widget">
                  <h3>Opening Hours</h3>
                  <ul class="opening_time">
                      <li>Monday - Friday 11:30am - 2:008pm</li>
                      <li>Saturday – Monday: 9am – 8pm</li>
                      <li>Monday - Friday 5:30am - 11:008pm</li>
                      <li>Saturday - Sunday 4:30am - 1:00pm</li>
                  </ul>
              </div>
          </div> -->
          <div class="col-lg-3 col-md-12 sm-padding">
              <div class="footer_widget">
                  <h3>Subscribe to our contents</h3>
                  <div class="subscribe_form">
                      <form action="#" class="subscribe_form">
                          <input type="email" name="email" id="subs-email" class="form_input"
                              placeholder="Email Address...">
                          <button type="submit" class="submit">SUBSCRIBE</button>
                          <div class="clearfix"></div>
                          <div id="subscribe-result">
                              <p class="subscription-success"></p>
                              <p class="subscription-error"></p>
                          </div>
                      </form>
                  </div>
              </div>
          </div>
      </div>
  </div>
</section>
<footer class="footer_section">
  <div class="container">
      <div class="row">
          <div class="col-md-6 xs-padding">
              <div class="copyright">&copy;
                  <script type="text/javascript"> document.write(new Date().getFullYear())</script> Barber Shop
                  
              </div>
          </div>
          <div class="col-md-6 xs-padding">
              <ul class="footer_social">
                  <li><a href="#">Orders</a></li>
                  <li><a href="#">Terms</a></li>
                  <li><a href="#">Report Problem</a></li>
              </ul>
          </div>
      </div>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
const token = localStorage.getItem("token") || null;

document.addEventListener("DOMContentLoaded", () => {
  const barberSelect = document.getElementById("book_barber");
  const serviceSelect = document.getElementById("book_service");
  const bookingForm = document.getElementById("booking_form");
  const areaInput = document.getElementById("book_area");
  const msgBox = document.getElementById("book_msg");
  const paymentSelect = document.getElementById("book_payment");

  // Initialize date/time picker
  flatpickr("#book_time", {
    enableTime: true,
    dateFormat: "Y-m-d H:i",
    minDate: "today",
    defaultHour: 10,
  });

  async function loadAllBarbers() {
    try {
      const res = await fetch("http://localhost:5000/barber/barbers");
      const allBarbers = await res.json();

      // Clear previous options
      barberSelect.innerHTML = '<option value="">Select Barber</option>';
      serviceSelect.innerHTML = '<option value="">Select Service</option>';

      allBarbers.forEach(barber => {
        const option = document.createElement("option");
        option.value = barber._id;
        option.text = `${barber.name} - ${barber.location}`;
        barberSelect.appendChild(option);
      });

      barberSelect.addEventListener("change", () => {
        const selectedBarber = allBarbers.find(barber => barber._id === barberSelect.value);
        if (selectedBarber) {
          areaInput.value = selectedBarber.location || "";
          renderServices(selectedBarber.services, selectedBarber.employees);
        } else {
          areaInput.value = "";
          serviceSelect.innerHTML = '<option value="">Select Service</option>';
        }
      });
    } catch (err) {
      console.error("Failed to load barbers:", err);
    }
  }

  function renderServices(services, employees) {
    serviceSelect.innerHTML = '<option value="">Select Service</option>';

    if (!Array.isArray(employees) || employees.length === 0) {
      console.warn("No employees data available.");
      employees = [];
    }

    services.forEach(service => {
      employees.forEach(emp => {
        const option = document.createElement("option");
        option.value = `${service.type}|${service.price}|${emp._id}`;
        const statusColor = emp.availabilityStatus === 'Available' ? 'green' : 'red';
        option.textContent = `${service.type} - NPR ${service.price} (${emp.name} - ${emp.availabilityStatus})`;
        serviceSelect.appendChild(option);
      });
    });
  }



  bookingForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const selectedService = document.getElementById("book_service").value;
  if (!selectedService) {
    msgBox.textContent = "Please select a service.";
    msgBox.className = "alert alert-warning";
    msgBox.style.display = "block";
    return;
  }

  const [service, price, employeeId] = selectedService.split("|");
  const paymentMethod = paymentSelect.value;

  const payload = {
    name: document.getElementById("book_name").value,
    phone: document.getElementById("book_phone").value,
    bookingTime: document.getElementById("book_time").value,
    service,
    price: parseFloat(price),
    area: document.getElementById("book_area").value,
    barberId: document.getElementById("book_barber").value,
    employeeId
  };

  if (paymentMethod === "Cash") {
    try {
      const res = await fetch("http://localhost:5000/book/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify({ ...payload, paymentMethod }),
      });

      const data = await res.json();
      if (res.ok) {
        msgBox.textContent = data.msg || "Booking successful with cash payment!";
        msgBox.className = "alert alert-success";
        msgBox.style.display = "block";
        bookingForm.reset();
        serviceSelect.innerHTML = '<option value="">Select Service</option>';
        areaInput.value = '';
      } else {
        msgBox.textContent = data.msg || "Booking failed!";
        msgBox.className = "alert alert-danger";
        msgBox.style.display = "block";
      }
    } catch (err) {
      console.error("Booking submission failed:", err);
      msgBox.textContent = "Failed to submit booking.";
      msgBox.className = "alert alert-danger";
      msgBox.style.display = "block";
    }
  } 
  else if (paymentMethod === "Online") {
    try {
      const initiateRes = await fetch("http://localhost:5000/book/esewa-initiate", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(payload)
      });

      const {
        transaction_uuid,
        signature,
        total_amount,
        product_code,
        signed_fields
      } = await initiateRes.json();

      if (!transaction_uuid || !signature) {
        throw new Error("Failed to initiate eSewa payment");
      }

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = 'https://rc-epay.esewa.com.np/api/epay/main/v2/form';

      const params = {
        amount: total_amount,
        tax_amount: '0',
        total_amount: total_amount,
        transaction_uuid: transaction_uuid,
        product_code: product_code,
        product_service_charge: '0',
        product_delivery_charge: '0',
        success_url: 'http://localhost:5000/book/esewa-callback',
        failure_url: 'http://localhost:5000/book/esewa-callback',
        signed_field_names: 'total_amount,transaction_uuid,product_code',
        signature: signature
      };

      console.log("📤 Submitting eSewa form with:", params);

      Object.entries(params).forEach(([key, value]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = key;
        input.value = value;
        form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();

    } catch (err) {
      console.error("eSewa payment failed:", err);
      msgBox.textContent = err.message || "Payment initiation failed";
      msgBox.className = "alert alert-danger";
      msgBox.style.display = "block";
    }
  }

});

// Auto-fill barber and user details from localStorage
const selectedBarber = JSON.parse(localStorage.getItem("selectedBarber"));
const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser"));

if (loggedInUser) {
  document.getElementById("book_name").value = loggedInUser.name || "";
  document.getElementById("book_email").value = loggedInUser.email || "";
}

if (selectedBarber) {
  const checkInterval = setInterval(() => {
    const barberSelect = document.getElementById("book_barber");
    if (barberSelect && barberSelect.options.length > 1) {
      barberSelect.value = selectedBarber.id;
      barberSelect.dispatchEvent(new Event("change")); // triggers area fill and services
      clearInterval(checkInterval);

      // 🧹 Remove the barber info after pre-filling to avoid future autofills
      localStorage.removeItem("selectedBarber");
    }
  }, 100);
}



  loadAllBarbers();
});
</script>
</body>
</html>